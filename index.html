<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cactus - Jeu de Cartes</title>
  <style>
    body {
      font-family: 'Comic Sans MS', cursive, sans-serif;
      text-align: center;
      background: url('https://images.unsplash.com/photo-1616627989393-c4641c9c5c80?auto=format&fit=crop&w=1500&q=80');
      background-size: cover;
      background-position: center;
      color: #333;
      margin: 0;
      padding: 0;
    }
    .game-area { margin-top: 20px; }
    .card-wrapper {
      display: inline-block;
      margin: 10px;
      position: relative;
    }
    .card {
      width: 80px;
      height: 120px;
      background: #4a90e2;
      border-radius: 10px;
      border: 2px solid white;
      text-align: center;
      line-height: 120px;
      font-size: 24px;
      font-weight: bold;
      color: white;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .card.selectable-start { outline: 3px dashed yellow; }
    .card.highlight { outline: 3px solid lime; box-shadow: 0 0 10px lime; }
    .discard-btn {
      position: absolute;
      top: -25px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 12px;
      padding: 4px 6px;
      border-radius: 6px;
      background: crimson;
      color: white;
      border: none;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    #log {
      margin-top: 20px;
      padding: 10px;
      border: 2px dashed #333;
      background: rgba(255, 255, 255, 0.8);
      text-align: left;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    button {
      font-family: 'Comic Sans MS', cursive, sans-serif;
      font-size: 16px;
      padding: 10px 20px;
      margin: 10px 5px;
      border: none;
      border-radius: 30px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    button:hover {
      transform: scale(1.05);
    }
    button:nth-of-type(1) { background-color: #00bfff; color: white; } /* Piocher */
    button:nth-of-type(2) { background-color: #ffa500; color: white; } /* √âchanger */
    button:nth-of-type(3) { background-color: #32cd32; color: white; } /* Cactus */
    button:nth-of-type(4) { background-color: #ff69b4; color: white; } /* Skip Special */
    button#reset-game, button#start-game { background-color: #4b0082; color: white; }

<style>
  #scoreboard {
    position: absolute;
    top: 10px;
    right: 10px;
    background-color: #f0f0f0;
    border: 1px solid #ccc;
    padding: 10px;
    border-radius: 8px;
    text-align: left;
    font-size: 14px;
  }
</style>
</head>
<body>
  <div id="welcome" style="padding: 40px; background-color: rgba(255,255,255,0.95); position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center;">
    <h1>Bienvenue sur Cactus üåµ</h1>
    <p>Connecte-toi pour rejoindre ou cr√©er une partie !</p>
    <input type="text" id="username" placeholder="Pseudo" style="padding: 10px; font-size: 16px; border-radius: 10px; margin: 10px;">
    <button onclick="login()" style="background-color: #32cd32; color: white;">Connexion</button>
  </div>
  <div id="scoreboard">
    <strong>Score</strong><br>
    Joueur 1 : <span id="score-j1">0</span><br>
    Joueur 2 : <span id="score-j2">0</span><br>
    Manche : <span id="manche-count">1</span>
  </div>
  <div id="config" style="margin: 20px auto; max-width: 400px;">
    <h3>Configuration de la partie</h3>
    <label>Nombre de cartes par joueur : <input type="number" id="card-count" min="3" max="7" value="4"></label><br><br>
    <label>Nombre de cartes visibles au d√©but : <input type="number" id="visible-count" min="0" max="7" value="2"></label><br><br>
    <label>Score pour gagner : <input type="number" id="target-score" min="1" max="10" value="3"></label><br><br>
    <button onclick="startNewGame()">Lancer la partie</button>
  </div>
  <div id="game" style="display:none;">
    <div class="game-area" id="game-area">
      <h2>Joueur 1</h2>
      <div id="player-cards"></div>
      <h2>Joueur 2</h2>
      <div id="opponent-cards"></div>

      <button onclick="drawCard()">Piocher une carte</button>
      <button onclick="initiateDiscardSwap()">Prendre de la d√©fausse</button>
      <button id="skip-special" style="display:none;" onclick="skipSpecial()">Passer l'action sp√©ciale</button>
      <button onclick="declareCactus()">Cactus</button>

      <div id="discard-pile">D√©fausse: <span id="discard">Vide</span></div>
      <p id="turn-info">Tour du joueur 1</p>
      <p id="drawn-card" style="display: none; cursor: pointer;" onclick="discardDrawnCard()">Carte pioch√©e: <span id="new-card"></span></p>
    </div>
    <button onclick="startNewRound()">Nouvelle manche</button>
    <button id="reset-game" onclick="resetGame()" style="display:none; margin-top:10px;">Nouvelle partie</button>
    $1
  </div>

  <script>
// === D√âBUT LOGIQUE COMPL√àTE DU JEU ===

let cardCount = 4, targetScore = 3, startVisibleCount = 2;
let playerCards = [], opponentCards = [], discardPile = [], drawnCard = null;
let currentPlayer = 1, specialAction = false, pendingSpecial = null, selectedForSwap = null;
let cactusPlayer = null, cactusDeclared = false, cactusCountdown = 0;
let score1 = 0, score2 = 0;
const cardValues = ["R", "A", 2, 3, 4, 5, 6, 7, 8, 9, 10, "V", "D"];

function drawRandomCard() {
  return cardValues[Math.floor(Math.random() * cardValues.length)];
}

let mancheCount = 1;

function login() {
  const username = document.getElementById("username").value.trim();
  if (!username) return alert("Entre un pseudo pour continuer.");
  document.getElementById("welcome").style.display = "none";
  document.getElementById("config").style.display = "block";
  logAction("üëã Bienvenue, " + username + " !");
}

function startNewGame() {
  if (typeof window.syncTurnToFirebase !== 'function') {
    console.error("‚õî syncTurnToFirebase non disponible. Attendez que Firebase soit pr√™t.");
    alert("Erreur : Firebase non initialis√©. Veuillez recharger la page.");
    return;
  }
  cardCount = parseInt(document.getElementById("card-count").value);
  targetScore = parseInt(document.getElementById("target-score").value);
  startVisibleCount = parseInt(document.getElementById("visible-count").value);
  score1 = 0;
  score2 = 0;
  document.getElementById("config").style.display = "none";
  document.getElementById("game").style.display = "block";
  startNewRound();
}

function updateScoreboard() {
  document.getElementById("score-j1").innerText = score1;
  document.getElementById("score-j2").innerText = score2;
  document.getElementById("manche-count").innerText = mancheCount;
}

function startNewRound() {
  drawnCard = null;
  discardPile = [];
  specialAction = false;
  pendingSpecial = null;
  selectedForSwap = null;
  cactusPlayer = null;
  cactusDeclared = false;
  cactusCountdown = 0;
  currentPlayer = 1;
  syncTurnToFirebase(currentPlayer);
  playerCards = Array.from({ length: cardCount }, drawRandomCard);
  opponentCards = Array.from({ length: cardCount }, drawRandomCard);
  document.getElementById("discard").innerText = "Vide";
  document.getElementById("drawn-card").style.display = "none";
  document.getElementById("skip-special").style.display = "none";
  document.getElementById("log").innerHTML = "";
  renderCards();
  updateTurnInfo();
  setTimeout(() => revealInitialCards(1), 500);
}

function renderCards() {
  renderPlayerCards("player-cards", playerCards, 1);
  renderPlayerCards("opponent-cards", opponentCards, 2);
}

function renderPlayerCards(containerId, cards, playerId) {
  const container = document.getElementById(containerId);
  container.innerHTML = "";
  cards.forEach((_, index) => {
    container.innerHTML += `
      <div class="card-wrapper">
        <button class="discard-btn" onclick="manualDiscard(${playerId}, ${index})">üóë</button>
        <div class="card" data-player="${playerId}" data-index="${index}" onclick="selectCard(this)">?</div>
      </div>`;
  });
}

function updateTurnInfo() {
  document.getElementById("turn-info").innerText = "Tour du joueur " + currentPlayer;
}

function revealInitialCards(player) {
  const set = player === 1 ? playerCards : opponentCards;
  const containerId = player === 1 ? "player-cards" : "opponent-cards";
  const container = document.getElementById(containerId).children;
  let toReveal = Math.min(startVisibleCount, set.length);
  let revealed = 0;
  logAction("üëÜ Joueur " + player + ", choisissez " + toReveal + " carte(s) √† regarder.");
  for (let i = 0; i < container.length; i++) {
    const cardDiv = container[i].querySelector(".card");
    cardDiv.classList.add("selectable-start");
    cardDiv.addEventListener("click", function handleClick() {
      if (revealed >= toReveal || parseInt(cardDiv.getAttribute("data-player")) !== player) return;
      const index = parseInt(cardDiv.getAttribute("data-index"));
      cardDiv.innerText = set[index];
      revealed++;
      if (revealed === toReveal) {
        logAction("üëÄ Joueur " + player + " a regard√© ses " + toReveal + " cartes de d√©part.");
        setTimeout(() => {
          for (let j = 0; j < container.length; j++) {
            const c = container[j].querySelector(".card");
            c.classList.remove("selectable-start");
            c.innerText = "?";
          }
          if (player === 1) setTimeout(() => revealInitialCards(2), 500);
        }, 5000);
      }
    });
  }
}

function logAction(msg) {
  document.getElementById("log").innerHTML += `<p>${msg}</p>`;
}

// === LOGIQUE COMPL√âMENTAIRE RESTAUR√âE ===

function drawCard() {
  if (drawnCard !== null) return;
  
  drawnCard = drawRandomCard();
  document.getElementById("new-card").innerText = drawnCard;
  document.getElementById("drawn-card").style.display = "block";
  logAction("üÉè Carte pioch√©e : " + drawnCard);
}

function initiateDiscardSwap() {
  if (discardPile.length === 0 || drawnCard !== null) return;
  if (cactusDeclared && currentPlayer !== cactusPlayer && cactusCountdown > 0) {
    logAction("üö´ Vous ne pouvez jouer qu'une fois apr√®s Cactus.");
    return;
  }
  drawnCard = discardPile.pop();
  document.getElementById("new-card").innerText = drawnCard;
  document.getElementById("drawn-card").style.display = "block";
  logAction("üîÅ Carte prise de la d√©fausse : " + drawnCard);
}

function discardDrawnCard() {
  if (!drawnCard) return;
  discardPile.push(drawnCard);
  document.getElementById("discard").innerText = drawnCard;
  document.getElementById("drawn-card").style.display = "none";
  const isSpecial = handleSpecialCard(drawnCard);
  drawnCard = null;
  renderCards();
  if (!isSpecial) endTurn();
}

function manualDiscard(player, index) {
  const set = player === 1 ? playerCards : opponentCards;
  const card = set[index];
  const top = discardPile[discardPile.length - 1];
  const activeSet = currentPlayer === 1 ? playerCards : opponentCards;
  const opponentSet = currentPlayer === 1 ? opponentCards : playerCards;

  // Cas 1 : Le joueur actif essaie de d√©fausser une carte de l'adversaire
  if (player !== currentPlayer) {
    if (card === top) {
      logAction("‚ö†Ô∏è D√©fausse synchronis√©e r√©ussie sur le jeu adverse : " + card);
      discardPile.push(card);
      document.getElementById("discard").innerText = card;
      set.splice(index, 1); // retirer la carte de l‚Äôadversaire

      if (activeSet.length > 0) {
        const givenCard = activeSet.shift(); // donner la premi√®re carte du joueur actif
        opponentSet.push(givenCard);
        logAction("üéÅ Joueur " + currentPlayer + " donne une carte √† l'adversaire : " + givenCard);
      }
    } else {
      logAction("‚ùå Mauvaise tentative de d√©fausse adverse. Le joueur actif pioche une p√©nalit√©.");
      const penalty = drawRandomCard();
      activeSet.push(penalty);
    }
    renderCards();
    return;
  }

  // Cas 2 : Le joueur actif d√©fausse une de ses propres cartes
  const oldPlayer = currentPlayer;
  if (card === top) {
    discardPile.push(card);
    document.getElementById("discard").innerText = card;
    set.splice(index, 1);
    logAction("‚úÖ Carte d√©fauss√©e correctement : " + card);
  } else {
    const penalty = drawRandomCard();
    set[index] = penalty;
    discardPile.push(card);
    document.getElementById("discard").innerText = card;
    logAction("‚ùå Mauvaise d√©fausse. P√©nalit√© : carte cach√©e ajout√©e.");
  }
  const isSpecial = handleSpecialCard(card);
  if (!isSpecial) currentPlayer = oldPlayer;
  renderCards();
}

function handleSpecialCard(card) {
  if (card === 8) {
    specialAction = true;
    pendingSpecial = 8;
    document.getElementById("skip-special").style.display = "inline-block";
    logAction("üëÅ Effet sp√©cial : regardez une de vos cartes.");
    return true;
  }
  if (card === 10) {
    specialAction = true;
    pendingSpecial = 10;
    document.getElementById("skip-special").style.display = "inline-block";
    logAction("üîç Effet sp√©cial : regardez une carte adverse.");
    return true;
  }
  if (card === "V") {
    specialAction = true;
    pendingSpecial = "V";
    document.getElementById("skip-special").style.display = "inline-block";
    logAction("üîÑ Effet sp√©cial : √©changez une carte avec l'adversaire.");
    return true;
  }
  return false;
}

function skipSpecial() {
  specialAction = false;
  pendingSpecial = null;
  selectedForSwap = null;
  document.getElementById("skip-special").style.display = "none";
  logAction("‚è≠ Action sp√©ciale ignor√©e");
  endTurn();
}

function clearHighlights() {
  document.querySelectorAll('.card').forEach(el => el.classList.remove('highlight'));
}

function selectCard(cardEl) {
  clearHighlights();
  cardEl.classList.add('highlight');
  const index = parseInt(cardEl.dataset.index);
  const player = parseInt(cardEl.dataset.player);
  const set = player === 1 ? playerCards : opponentCards;
  if (specialAction && pendingSpecial === 8 && player === currentPlayer) {
  if (selectedForSwap !== null) return; // emp√™che plusieurs clics
  selectedForSwap = true;
  cardEl.innerText = set[index];
  logAction("üëÅ Carte r√©v√©l√©e : " + set[index]);
  setTimeout(() => {
    cardEl.innerText = "?";
    selectedForSwap = null;
    skipSpecial();
  }, 5000);
  return;
} if (specialAction && pendingSpecial === 10 && player !== currentPlayer) {
  if (selectedForSwap !== null) return; // emp√™cher plusieurs clics
  selectedForSwap = true;
  cardEl.innerText = set[index];
  logAction("üîç Carte adverse : " + set[index]);
  setTimeout(() => {
    cardEl.innerText = "?";
    selectedForSwap = null;
    skipSpecial();
  
  }, 5000);
    return;
  }
  if (specialAction && pendingSpecial === "V") {
    if (!selectedForSwap && player === currentPlayer) {
      selectedForSwap = { player, index };
      logAction("üëâ Choisissez une carte adverse √† √©changer.");
      return;
    }
    if (selectedForSwap && player !== currentPlayer) {
      const setA = selectedForSwap.player === 1 ? playerCards : opponentCards;
      const setB = player === 1 ? playerCards : opponentCards;
      const temp = setA[selectedForSwap.index];
      setA[selectedForSwap.index] = setB[index];
      setB[index] = temp;
      selectedForSwap = null;
      logAction("üîÑ Cartes √©chang√©es.");
      renderCards();
      skipSpecial();
      return;
    }
  }
  if (player !== currentPlayer || drawnCard === null) return;
  const replaced = set[index];
  set[index] = drawnCard;
  discardPile.push(replaced);
  document.getElementById("discard").innerText = replaced;
  drawnCard = null;
  document.getElementById("drawn-card").style.display = "none";
  logAction("üîÑ Carte √©chang√©e : " + replaced + " ‚Üî " + set[index]);
  const isSpecial = handleSpecialCard(replaced);
  renderCards();
  if (!isSpecial) endTurn();
}

function endTurn() {
  if (specialAction) return;
  if (cactusDeclared && currentPlayer !== cactusPlayer) {
    revealFinalScores();
    return;
  }
  
  currentPlayer = currentPlayer === 1 ? 2 : 1;
  syncTurnToFirebase(currentPlayer);
  updateTurnInfo();
  renderCards();
  logAction("üîÅ Tour du joueur " + currentPlayer);
}

function declareCactus() {
  if (cactusDeclared) return;
  cactusDeclared = true;
  cactusPlayer = currentPlayer;
  logAction("üåµ Joueur " + currentPlayer + " dit Cactus !");
  endTurn();
}

function revealFinalScores() {
  mancheCount++;
  updateScoreboard();
  const sum = cards => cards.reduce((t, c) => t + getCardValue(c), 0);
  const total1 = sum(playerCards);
  const total2 = sum(opponentCards);
  renderCards();
  logAction("üßÆ Joueur 1 : " + total1);
  logAction("üßÆ Joueur 2 : " + total2);
  if (playerCards.every(c => c === "R")) logAction("üëë Joueur 1 a un Cactus Royal !");
  if (opponentCards.every(c => c === "R")) logAction("üëë Joueur 2 a un Cactus Royal !");
  if (total1 <= 5 || total2 <= 5) {
    const winner = total1 < total2 ? 1 : total2 < total1 ? 2 : "√©galit√©";
    if (winner === "√©galit√©") logAction("ü§ù √âgalit√© sous les 5 points !");
    else {
      logAction("üèÜ Joueur " + winner + " remporte la manche !");
      if (winner === 1) score1++;
      if (winner === 2) score2++;
      logAction("üìä Scores : J1=" + score1 + " | J2=" + score2);
      if (score1 >= targetScore || score2 >= targetScore) {
        logAction("üéâ Joueur " + (score1 >= targetScore ? 1 : 2) + " remporte la partie !");
        document.getElementById("reset-game").style.display = "inline-block";
    }
    }
  } else logAction("‚ùå Aucun joueur n‚Äôa r√©ussi le Cactus.");
}

function getCardValue(card) {
  if (card === "R") return 0;
  if (card === "A") return 1;
  if (card === 2) return -2;
  if (["V", "D"].includes(card)) return 10;
  return typeof card === "number" ? card : 10;
}

function resetGame() {
  document.getElementById("config").style.display = "block";
  document.getElementById("game").style.display = "none";
  document.getElementById("reset-game").style.display = "none";
  document.getElementById("log").innerHTML = "";
  score1 = 0;
  score2 = 0;
  mancheCount = 1;
  updateScoreboard();
}

// === FIN LOGIQUE COMPL√àTE DU JEU ===
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-auth.js";

const auth = getAuth(app);

// Remplace le bloc #welcome par un formulaire complet d'inscription/connexion
const welcomeDiv = document.getElementById("welcome");
welcomeDiv.innerHTML = `
  <h1>Bienvenue sur Cactus üåµ</h1>
  <p>Inscris-toi ou connecte-toi pour jouer</p>
  <input type="email" id="email" placeholder="Adresse e-mail" style="padding: 10px; font-size: 16px; border-radius: 10px; margin: 5px;">
  <input type="password" id="password" placeholder="Mot de passe" style="padding: 10px; font-size: 16px; border-radius: 10px; margin: 5px;">
  <div>
    <button onclick="register()" style="background-color: #32cd32; color: white;">Cr√©er un compte</button>
    <button onclick="loginFirebase()" style="background-color: #ffa500; color: white;">Connexion</button>
  </div>
`;

window.register = function () {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  createUserWithEmailAndPassword(auth, email, password)
    .then(() => alert("‚úÖ Compte cr√©√© avec succ√®s !"))
    .catch((error) => alert("Erreur: " + error.message));
};

window.loginFirebase = function () {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  signInWithEmailAndPassword(auth, email, password)
    .then(() => {
      document.getElementById("welcome").style.display = "none";
      document.getElementById("config").style.display = "block";
      logAction("üëã Connect√© avec succ√®s");
    })
    .catch((error) => alert("Erreur de connexion: " + error.message));
};

onAuthStateChanged(auth, (user) => {
  if (user) {
    document.getElementById("welcome").style.display = "none";
    document.getElementById("config").style.display = "block";
    logAction("üîì Session active d√©tect√©e");
  }
});
</script>
  <div id="log"></div>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js";
  import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBd2O4MWVNlY5MOVffdcvMrkj2lLxJcdv0",
    authDomain: "cactus-game-12ae9.firebaseapp.com",
    projectId: "cactus-game-12ae9",
    storageBucket: "cactus-game-12ae9.appspot.com",
    messagingSenderId: "852427558969",
    appId: "1:852427558969:web:0b292c74c6305dc348fde8",
    databaseURL: "https://cactus-game-12ae9-default-rtdb.firebaseio.com/"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // === SYNCHRONISATION EN TEMPS R√âEL DU TOUR ===

  // Mettre √† jour le tour dans Firebase √† chaque changement
  window.syncTurnToFirebase = function (turn) {
    set(ref(db, 'game/currentPlayer'), turn);
  }

  // √âcouter les changements de tour depuis Firebase
  const turnRef = ref(db, 'game/currentPlayer');
  onValue(turnRef, (snapshot) => {
    const val = snapshot.val();
    if (val !== null && val !== currentPlayer) {
      currentPlayer = val;
      updateTurnInfo();
      renderCards();
      logAction("üîÑ Mise √† jour du tour re√ßue : Joueur " + currentPlayer);
    }
  });
  const testRef = ref(db, 'test/');
  onValue(testRef, (snapshot) => {
    const data = snapshot.val();
    console.log("üîÑ Donn√©es re√ßues :", data);
  });
</script>
</body>
</html>
