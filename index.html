tPlayer;
  if (card === top) {
    discardPile.push(card);
    document.getElementById("discard").innerText = card;
    set.splice(index, 1);
    logAction("‚úÖ Carte d√©fauss√©e correctement : " + card);
  } else {
    const penalty = drawRandomCard();
    set[index] = penalty;
    discardPile.push(card);
    document.getElementById("discard").innerText = card;
    logAction("‚ùå Mauvaise d√©fausse. P√©nalit√© : carte cach√©e ajout√©e.");
  }
  const isSpecial = handleSpecialCard(card);
  if (!isSpecial) currentPlayer = oldPlayer;
  renderCards();
}

function handleSpecialCard(card) {
  if (card === 8) {
    specialAction = true;
    pendingSpecial = 8;
    document.getElementById("skip-special").style.display = "inline-block";
    logAction("üëÅ Effet sp√©cial : regardez une de vos cartes.");
    return true;
  }
  if (card === 10) {
    specialAction = true;
    pendingSpecial = 10;
    document.getElementById("skip-special").style.display = "inline-block";
    logAction("üîç Effet sp√©cial : regardez une carte adverse.");
    return true;
  }
  if (card === "V") {
    specialAction = true;
    pendingSpecial = "V";
    document.getElementById("skip-special").style.display = "inline-block";
    logAction("üîÑ Effet sp√©cial : √©changez une carte avec l'adversaire.");
    return true;
  }
  return false;
}

function skipSpecial() {
  specialAction = false;
  pendingSpecial = null;
  selectedForSwap = null;
  document.getElementById("skip-special").style.display = "none";
  logAction("‚è≠ Action sp√©ciale ignor√©e");
  endTurn();
}

function clearHighlights() {
  document.querySelectorAll('.card').forEach(el => el.classList.remove('highlight'));
}

function selectCard(cardEl) {
  clearHighlights();
  cardEl.classList.add('highlight');
  const index = parseInt(cardEl.dataset.index);
  const player = parseInt(cardEl.dataset.player);
  const set = player === 1 ? playerCards : opponentCards;
  if (specialAction && pendingSpecial === 8 && player === currentPlayer) {
  if (selectedForSwap !== null) return; // emp√™che plusieurs clics
  selectedForSwap = true;
  cardEl.innerText = set[index];
  logAction("üëÅ Carte r√©v√©l√©e : " + set[index]);
  setTimeout(() => {
    cardEl.innerText = "?";
    selectedForSwap = null;
    skipSpecial();
  }, 5000);
  return;
} if (specialAction && pendingSpecial === 10 && player !== currentPlayer) {
  if (selectedForSwap !== null) return; // emp√™cher plusieurs clics
  selectedForSwap = true;
  cardEl.innerText = set[index];
  logAction("üîç Carte adverse : " + set[index]);
  setTimeout(() => {
    cardEl.innerText = "?";
    selectedForSwap = null;
    skipSpecial();
  
  }, 5000);
    return;
  }
  if (specialAction && pendingSpecial === "V") {
    if (!selectedForSwap && player === currentPlayer) {
      selectedForSwap = { player, index };
      logAction("üëâ Choisissez une carte adverse √† √©changer.");
      return;
    }
    if (selectedForSwap && player !== currentPlayer) {
      const setA = selectedForSwap.player === 1 ? playerCards : opponentCards;
      const setB = player === 1 ? playerCards : opponentCards;
      const temp = setA[selectedForSwap.index];
      setA[selectedForSwap.index] = setB[index];
      setB[index] = temp;
      selectedForSwap = null;
      logAction("üîÑ Cartes √©chang√©es.");
      renderCards();
      skipSpecial();
      return;
    }
  }
  if (player !== currentPlayer || drawnCard === null) return;
  const replaced = set[index];
  set[index] = drawnCard;
  discardPile.push(replaced);
  document.getElementById("discard").innerText = replaced;
  drawnCard = null;
  document.getElementById("drawn-card").style.display = "none";
  logAction("üîÑ Carte √©chang√©e : " + replaced + " ‚Üî " + set[index]);
  const isSpecial = handleSpecialCard(replaced);
  renderCards();
  if (!isSpecial) endTurn();
}

function endTurn() {
  if (specialAction) return;
  if (cactusDeclared && currentPlayer !== cactusPlayer) {
    revealFinalScores();
    return;
  }
  
  currentPlayer = currentPlayer === 1 ? 2 : 1;
  syncTurnToFirebase(currentPlayer);
  updateTurnInfo();
  renderCards();
  logAction("üîÅ Tour du joueur " + currentPlayer);
}

function declareCactus() {
  if (cactusDeclared) return;
  cactusDeclared = true;
  cactusPlayer = currentPlayer;
  logAction("üåµ Joueur " + currentPlayer + " dit Cactus !");
  endTurn();
}

function revealFinalScores() {
  mancheCount++;
  updateScoreboard();
  const sum = cards => cards.reduce((t, c) => t + getCardValue(c), 0);
  const total1 = sum(playerCards);
  const total2 = sum(opponentCards);
  renderCards();
  logAction("üßÆ Joueur 1 : " + total1);
  logAction("üßÆ Joueur 2 : " + total2);
  if (playerCards.every(c => c === "R")) logAction("üëë Joueur 1 a un Cactus Royal !");
  if (opponentCards.every(c => c === "R")) logAction("üëë Joueur 2 a un Cactus Royal !");
  if (total1 <= 5 || total2 <= 5) {
    const winner = total1 < total2 ? 1 : total2 < total1 ? 2 : "√©galit√©";
    if (winner === "√©galit√©") logAction("ü§ù √âgalit√© sous les 5 points !");
    else {
      logAction("üèÜ Joueur " + winner + " remporte la manche !");
      if (winner === 1) score1++;
      if (winner === 2) score2++;
      logAction("üìä Scores : J1=" + score1 + " | J2=" + score2);
      if (score1 >= targetScore || score2 >= targetScore) {
        logAction("üéâ Joueur " + (score1 >= targetScore ? 1 : 2) + " remporte la partie !");
        document.getElementById("reset-game").style.display = "inline-block";
    }
    }
  } else logAction("‚ùå Aucun joueur n‚Äôa r√©ussi le Cactus.");
}

function getCardValue(card) {
  if (card === "R") return 0;
  if (card === "A") return 1;
  if (card === 2) return -2;
  if (["V", "D"].includes(card)) return 10;
  return typeof card === "number" ? card : 10;
}

function resetGame() {
  document.getElementById("config").style.display = "block";
  document.getElementById("game").style.display = "none";
  document.getElementById("reset-game").style.display = "none";
  document.getElementById("log").innerHTML = "";
  score1 = 0;
  score2 = 0;
  mancheCount = 1;
  updateScoreboard();
}

// === FIN LOGIQUE COMPL√àTE DU JEU ===


function createRoom() {
  const roomId = Math.random().toString(36).substring(2, 8).toUpperCase();
  const username = auth.currentUser?.email?.split("@")[0] || "joueur" + Math.floor(Math.random() * 1000);
  sessionStorage.setItem("roomId", roomId);
  sessionStorage.setItem("username", username);
  set(ref(db, `games/${roomId}/players/${username}`), { connected: true });
  set(ref(db, `games/${roomId}/currentPlayer`), 1);
  document.getElementById("config").style.display = "none";
  document.getElementById("setup").style.display = "block";
  logAction("üîß Partie cr√©√©e. Code : " + roomId);
  logAction("üë§ Joueur ajout√© : " + username);
  logAction("üë§ Joueur ajout√© : " + username);
}

function joinRoom() {
  const roomId = document.getElementById("room-code").value.trim().toUpperCase();
  const username = auth.currentUser?.email?.split("@")[0] || "joueur" + Math.floor(Math.random() * 1000);
  if (!roomId) return alert("Veuillez entrer un code de partie valide.");
  sessionStorage.setItem("roomId", roomId);
  sessionStorage.setItem("username", username);
  set(ref(db, `games/${roomId}/players/${username}`), { connected: true });
  document.getElementById("config").style.display = "none";
  document.getElementById("setup").style.display = "block";
  logAction("üîó Rejoint la partie : " + roomId);
  logAction("üë§ Joueur ajout√© : " + username);
  logAction("üë§ Joueur ajout√© : " + username);
}
</script>
  <div id="log"></div>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js";
  import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-database.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBd2O4MWVNlY5MOVffdcvMrkj2lLxJcdv0",
    authDomain: "cactus-game-12ae9.firebaseapp.com",
    projectId: "cactus-game-12ae9",
    storageBucket: "cactus-game-12ae9.appspot.com",
    messagingSenderId: "852427558969",
    appId: "1:852427558969:web:0b292c74c6305dc348fde8",
    databaseURL: "https://cactus-game-12ae9-default-rtdb.firebaseio.com/"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);

  window.syncTurnToFirebase = function (turn) {
    const roomId = sessionStorage.getItem("roomId");
    if (!roomId) return;
    set(ref(db, `games/${roomId}/currentPlayer`), turn);
  };

  const roomId = sessionStorage.getItem("roomId");
  if (roomId) {
    const turnRef = ref(db, `games/${roomId}/currentPlayer`);
    onValue(turnRef, (snapshot) => {
      const val = snapshot.val();
      if (val !== null && val !== currentPlayer) {
        currentPlayer = val;
        updateTurnInfo();
        renderCards();
        logAction("üîÑ Tour mis √† jour : Joueur " + currentPlayer);
      }
    });
  }

  window.register = function () {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    createUserWithEmailAndPassword(auth, email, password)
      .then(() => alert("‚úÖ Compte cr√©√© avec succ√®s !"))
      .catch((error) => alert("Erreur: " + error.message));
  };

  window.loginFirebase = function () {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    signInWithEmailAndPassword(auth, email, password)
      .then(() => {
        document.getElementById("welcome").style.display = "none";
        document.getElementById("config").style.display = "block";
        logAction("üëã Connect√© avec succ√®s");
      })
      .catch((error) => alert("Erreur de connexion: " + error.message));
  };

  onAuthStateChanged(auth, (user) => {
    if (user) {
      document.getElementById("welcome").style.display = "none";
      document.getElementById("config").style.display = "block";
      logAction("üîì Session active d√©tect√©e");
    }
  });
</script>
</body>
</html>
